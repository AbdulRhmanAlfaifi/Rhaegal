public MaliciousServiceInstalled
{
    metadata:
      author: "AbdulRhman Alfaifi"
      reference: "Init Rules"
      creationDate: "01/01/2019"
      score: 70
      description: "Detect RemoteAccessTool Service Installed"
    Channel: "System"
    include:
      EventID: "7045"
      Data.ServiceName: 
      - "*PSEXE*"
      - "*paexe*"
      - "*anydesk*"
      - "*mssecsvc*"
      - "*pwdump*"
      - '*gsecdump*'
      - '*cachedump*'
}

public AmCache_Cleared
{
    metadata:
      author: "AbdulRhman Alfaifi"
      reference: "Internal Research"
      creationDate: "13/02/2020"
      score: 70
      description: "Detects AmCache hive cleared"
    Channel: "System"
    include:
      EventID: "16"
      Data.HiveName: "*AmCache*"
      Data.KeysUpdated: "0"
}

public Powershell_Execution
{
    metadata:
      author: "AbdulRhman Alfaifi"
      reference: "Init Rules"
      creationDate: "01/01/2019"
      score: 100
      description: "Detect Malicious powershell execution"
    Channel: "Windows PowerShell"
    include:
      EventID: 
        - "600"
        - "403"
        - "400"
      Data2:
        - "*downloadstring*"
        - "*downloadfile*"
        - "*iex*"
        - "* -e *"
    returns:
    - Data2
}


public ScheduledTaskCreated
{
    metadata:
      author: "AbdulRhman Alfaifi"
      reference: "Init Rules"
      creationDate: "17/10/2019"
      score: 70
      description: "New Scheduled Task was Created"
    Channel: "Microsoft-Windows-TaskScheduler/Operational"
    include:
      EventID: "106"
}

public ScheduledTaskUpdated
{
    metadata:
      author: "AbdulRhman Alfaifi"
      reference: "Init Rules"
      creationDate: "17/10/2019"
      score: 70
      description: "New Scheduled Task was Updated"
    Channel: "Microsoft-Windows-TaskScheduler/Operational"
    include:
      EventID: "140"
}

public ScheduledTaskDeleted
{
    metadata:
      author: "AbdulRhman Alfaifi"
      reference: "Init Rules"
      creationDate: "17/10/2019"
      score: 70
      description: "New Scheduled Task was Deleted"
    Channel: "Microsoft-Windows-TaskScheduler/Operational"
    include:
      EventID: "141"
}


public PTHAttack_1
{
    metadata:
      author: "AbdulRhman Alfaifi"
      reference: "Init Rules"
      creationDate: "17/10/2019"
      score: 80
      description: "Pass the Hash was detected"
    Channel: "Security"
    include:
      EventID: "4624"
      Data.SubjectUserSid: "S-1-0-0"
      Data.LogonType: "3"
      Data.LogonProcessName: "NtLmSsp"
}

public PTHAttack_2
{
    metadata:
      author: "AbdulRhman Alfaifi"
      reference: "Init Rules"
      creationDate: "17/10/2019"
      score: 80
      description: "Pass the Hash was detected"
    Channel: "Security"
    include:
      EventID: "4624"
      Data.LogonType: "9"
      Data.LogonProcessName: "seclogo"
    exclude:
      Data.TargetUserName: "ANONYMOUS LOGON"
}


public Possible_Detection_of_CVE_EID1
{
    metadata:
      author: "AbdulRhman Alfaifi"
      reference: "https://gist.github.com/SwitHak/62fa7f8df378cae3a459670e3a18742d"
      creationDate: "16/01/2019"
      score: 100
      description: "This Event is generated when an attempt to exploit a known vulnerability is detected"
    Channel: "Application"
    include:
      EventID: "1"
      Provider.Name : "Microsoft-Windows-Audit-CVE"
}

public Possible_Detection_of_CVE_EID2
{
    metadata:
      author: "AbdulRhman Alfaifi"
      reference: "https://gist.github.com/SwitHak/62fa7f8df378cae3a459670e3a18742d"
      creationDate: "16/01/2019"
      score: 100
      description: "This Event is generated when an attempt to exploit a known vulnerability is detected"
    Channel: "System"
    include:
      EventID: "2"
      Provider.Name : "Microsoft-Windows-Audit-CVE"
}

public DetectPsExec
{
    metadata:
      author: "AbdulRhman Alfaifi"
      reference: "N/A"
      creationDate: "20/10/2019"
      score: 50
      description: "PsExec Execution Detected"
    include:
      rule:
      - "LoginType3"
      - "PsExecSeriveInstalled"
      if:
        within: 100
}


private LoginType3
{
    metadata:
      author: "AbdulRhman Alfaifi"
      reference: "N/A"
      creationDate: "20/10/2019"
      description: "Login type 3"
    Channel: "Security"
    include:
      EventID: "4624"
      Data.LogonType: "3"
    returns:
    - EventID
    - Channel
    - TimeCreated.SystemTime
    - Data.LogonType
    - Data.AuthenticationPackageName
    - Data.TargetUserName
    - Data.IpAddress
}

private PsExecSeriveInstalled
{
    metadata:
      author: "AbdulRhman Alfaifi"
      reference: "N/A"
      creationDate: "20/10/2019"
      description: "PsExec Service (PSEXESVC) Installed"
    Channel: "System"
    include:
      EventID: "7045"
      Data.ServiceName: "*PSEXESVC*"
    returns:
    - Data.ServiceName
    - Channel
    - TimeCreated.SystemTime
    - Security.UserID
    - Data.ImagePath
}

public Add_Type_cmdlet_execution
{
    metadata:
      author: "AbdulRhman Alfaifi"
      reference: "internal research"
      creationDate: "10/02/2020"
      score: 100
      description: "Deleted execution of Add-Type cmdlet which allow the execution of C# code."
    Channel: "Windows PowerShell"
    include:
      EventID: "800"
}

public PSSession_Outgoing_Connection
{
    metadata:
      author: "AbdulRhman Alfaifi"
      reference: "internal research"
      creationDate: "19/02/2020"
      score: 70
      description: "New PSSesion connection from client side"
    Channel: "Security"
    include:
      EventID: "4648"
      Data.ProcessName: "*powershell.exe*"
    returns:
    - Data.TargetUserName
    - Data.TargetDomainName
    - Data.TargetServerName
    - Data.TargetInfo
    - Data.ProcessName
}

public PSSession_Outgoing_Connection_2
{
    metadata:
      author: "AbdulRhman Alfaifi"
      reference: "internal research"
      creationDate: "19/02/2020"
      score: 70
      description: "New PSSesion connection from client side"
    Channel: "Microsoft-Windows-WinRM/Operational"
    include:
      EventID: "6"
    returns:
    - Data.connection
    - Security.UserID
}

public PSSession_Session_Started
{
    metadata:
      author: "AbdulRhman Alfaifi"
      reference: "internal research"
      creationDate: "19/02/2020"
      score: 70
      description: "New PSSesion Session Started"
    Channel: "Windows PowerShell"
    include:
      EventID: "400"
      Data0: "Available"
      Data2: "*HostName=ServerRemoteHost*"
    returns:
    - Data0
    - Data2
}

public PSSession_Session_Ended
{
    metadata:
      author: "AbdulRhman Alfaifi"
      reference: "internal research"
      creationDate: "19/02/2020"
      score: 70
      description: "New PSSesion Session Ended"
    Channel: "Windows PowerShell"
    include:
      EventID: "403"
      Data0: "Stopped"
      Data2: "*HostName=ServerRemoteHost*"
    returns:
    - Data0
    - Data2
}

public PSSession_Incomming_Ended
{
    metadata:
      author: "AbdulRhman Alfaifi"
      reference: "internal research"
      creationDate: "19/02/2020"
      score: 70
      description: "New PSSesion Incomming Connection"
    Channel: "Microsoft-Windows-WinRM/Operational"
    include:
      EventID: "31"
}

public Exchange_Exploit_CVE_2020_0688_Detected
{
    metadata:
      author: "AbdulRhman Alfaifi"
      reference: "internal research"
      creationDate: "11/03/2020"
      score: 400
      description: "Exchange expoint (cve-2020-0688) has been detected"
    Channel: "Application"
    include:
      EventID: "4"
      Data1: "*/ecp/default.aspx?__VIEWSTATEGENERATOR=*&__VIEWSTATE=*"
    returns:
    - Channel
    - Data1
}